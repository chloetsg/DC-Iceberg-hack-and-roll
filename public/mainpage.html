<!DOCTYPE html>
<html>
<head>
    <style>
        /* Basic Popup Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; width: 300px; text-align: center; border-radius: 10px; }
        img { max-width: 100%; height: auto; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <button id="startBtn">Verify Captcha</button>

    <div id="captchaModal" class="modal">
        <div class="modal-content">
            <h3>Draw the letters below:</h3>
            <img id="captchaImg" src="" alt="Loading...">
            
            <canvas id="drawingCanvas" width = "300" height="150", style="border:1px solid #000; cursor:crosshair;"></canvas>
            <br>
            <button onclick="submitDrawing()">Submit Answer</button>
        </div>
    </div>

    <script>
        // Image loading
        const startBtn = document.getElementById('startBtn');
        const modal = document.getElementById('captchaModal');
        const captchaImg = document.getElementById('captchaImg');

        startBtn.onclick = async function() {
            // 1. Request the image from your Python function
            const response = await fetch('/api/get-captcha');
            const data = await response.json();

            // 2. Insert the Base64 string into the image tag
            captchaImg.src = `data:image/png;base64,${data.image}`;

            // 3. Show the popup
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Drawing functionality
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        // --- Drawing Logic ---
        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);

        function draw(e) {
            if (!drawing) return;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';

            // Get correct coordinates relative to canvas
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        // --- Sending to Python ---
        async function submitDrawing() {
            // 1. Convert canvas to Base64
            const imageBase64 = canvas.toDataURL('image/png');

            // 2. Send to your Vercel Python API
            const response = await fetch('/api/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    drawing: imageBase64,
                    text: document.getElementById('captchaImg').dataset.answer // Hidden state
                })
            });

            const result = await response.json();
            alert(result.status === "SUCCESS" ? "Verified!" : "Try Again");
        }
    </script>
</body>
</html>